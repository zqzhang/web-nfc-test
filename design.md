# Web NFC API Test Design

## Introduction

This document is trying to design web platform tests for the
[Web NFC API](https://w3c.github.io/web-nfc/) specification.

The designed test cases are described by **test assertion** with proper
pre-/post-condition.

## Terms

Most of the terms are defined in W3C
[test methodology](http://www.w3.org/TR/test-methodology/) specification
which specifies a method for wirting testable conformance requirements.

* **Requirement** means conformance requirement of the API specification
  to be tested.
* **Test assertion** is a prose description of a test case intended for human
  testers - i.e., for a given test case, testable assertion defines exactly
  what the user agent needs to do (behaviorally or conditionally) to pass the
  test case. It is important to note that testable assertions don’t appear in
  a specification - they only appear in a test suite to describe a test case. 
* A **test case** is a machine processable object that is used to test one
  or more conformance requirements

## Test Design

### IDL to Test

**Requirement**: Implementations that use ECMAScript to implement the APIs
defined in this document MUST implement them in a manner consistent with the
ECMAScript Bindings defined in the
[Web IDL specification](http://www.w3.org/TR/WebIDL-1/),
as this document uses that specification and terminology.

**Test assertions**: Test that a user agent (UA) is a [conforming ECMAScript
implementation](https://heycam.github.io/webidl/#dfn-conforming-ecmascript-implementation).
To pass, the UA must pass all the tests automatically generated by
[idlharness.js](https://github.com/w3c/testharness.js/blob/master/idlharness.js),
based on the Web IDL fragments specified by the Web NFC specification
within `<pre class="idl">`.

Feel free to try the un-reviewed idlharness.js based tests for Web NFC API at
https://zqzhang.github.io/demo/idlharness/webnfc.html

**Issue #1**: As per https://www.chromium.org/developers/web-idl-interfaces,
though Web IDL in Blink is close to the standard, and the resulting bindings
use standard conventions to call Blink code, there are additional features to
specify implementation details, primarily Blink IDL extended attributes. This
will result in many failures of the idlharness.js based tests running on Chrome.
I am not sure whether the Web NFC API has same issue.

A possible solution to this issue is to extend the existing test cases in
[idl-NavigatorNFC.html](https://zqzhang.github.io/demo/webnfc/idl-NavigatorNFC.html)
and [idl-NFC.html](https://zqzhang.github.io/demo/webnfc/idl-NFC.html)
to check the Web IDL fragments with reference to the checkpoints in
idlharness.js; and then change to idlharness.js based tests after resolving
the issue.

**Issue #2**: The Web NFC API spec refers to http://www.w3.org/TR/WebIDL-1/,
a W3C Working Draft 04 August 2015, while the idlharness.js is always updating
with latest Editor's Draft https://heycam.github.io/webidl/. So there is a
potential issue here that the Web IDL spec development will make difference
among the API specification, API implementation and idlharness.js framework.

**Note**: There is a reference mismatch for the WebIDL specification. In
normative reference section, it is http://www.w3.org/TR/WebIDL-1/; while in
terminology and conventions section http://heycam.github.io/webidl/. Maybe
the spec editors can resolve this and the issue #2 together.

### Use Case and Example to Test

#### Reading an NFC tag

```js
// Reading an NFC tag containing a Web NFC message,
// when a web page using the Web NFC API is open and in focus. 
navigator.nfc.watch((message) => {
  // Test assertion: check that successfully read an NFC device.

  // Issue: seems it cannot get here if ndef.TNF is 6 (NFC Unchaged Type record)
  // or 7 (NFC Reserved Type record), surpose there is a tag with such record.
  // Then the watch doesn't take effect as it cannot read the NFC tag, right?
  // Or will it reject the promise?

  // Process massage here to check more.
  processMessage(message);
}).then(() => {
  // Added a watch.
  // Test assertion: check that navigator.nfc.watch() returns a promise.
}).catch((error) => {
  // Failed to add a watch.
  // Can further check the errors, e.g. SecurityError, NotSupportedError.
});

// Reference to EXAMPLE 4 with some modifications.
function processMessage(message) {
  // Test assertion: check that message is a dictionary of NFCMessage, etc.
  // https://w3c.github.io/web-nfc/#dom-nfcmessage

  for (let record of message.data) {
    // Test assertions: check that a certain type of record is read.
    // These assertions are useful for reading -> re-writing -> reading cases.

    // The record here shall be NDEF record parsed following
    // https://w3c.github.io/web-nfc/#dfn-parsing-ndef-record
    switch (record.recordType) {
      case "empty":
        // record.mediaType = ""
        break;
      case "text":
        // record.mediaType = "text/plain"
        // record.mediaType = "text/plain;lang=*"
        break;
      case "url":
        // record.mediaType = "text/plain"
        break;
      case "json":
        // record.mediaType = "application/*json"
        break;
      case "opaque":
        // record.mediaType = ndef.TYPE 
        // record.mediaType = "application/octet-stream"
        break;
      default:
        // The 4.8 step doesn't specify the `record.recordType`,
        // we can check the message.url here.
        // Maybe this is a spec bug because the 5 step says that only
        // If NFC@[[suspended]] is false and message.data is not empty,
        // run the dispatch NFC content steps given message.
        break;
    }
  }
}
```

```js
// Reading an NFC tag containing other than Web NFC message,
// when a web page using the Web NFC API is open and in focus.
// Does this mean the issue I mentioned above that ndef.TNF is
// 6 (NFC Unchaged Type record)
// or 7 (NFC Reserved Type record)?
```

```js
// Reading an NFC tag
// when no web site using the Web NFC API is open or in focus.
// Seems this use-case includes handling Window visibility and focus described
// at https://w3c.github.io/web-nfc/#handling-window-visibility-and-focus
// However the spec is not clear about what is to be expected.
// See https://w3c.github.io/web-nfc/#the-ndef-parsing-algorithm
// "If NFC@[[suspended]] is true, abort these steps."
```

**Pre-condition**: avaiable NFC tag and successfully tap simulation. The
`NFCWatchOptions` doesn't specify whether it is a tag or a peer.

**Notes**:

* Spec typo `NFC.watch(options, callback)` at
  https://w3c.github.io/web-nfc/#dom-nfc-watch; 
  should be `NFC.watch(callback, options)`.
* Spec typo "`MessageCallback`var>callback" at the 1.7 step
  https://w3c.github.io/web-nfc/#dfn-dispatch-nfc-content;
  should be `<code>MessageCallback</code> <var>callback</var>` in source file.
* Spec typo `"application/octet-stream` at the 4.9.2 step
  https://w3c.github.io/web-nfc/#dfn-parsing-ndef-record;
  miss a `"`.
* Spec error in Example 4 `case "string":`; should be `case "text":` per
  https://w3c.github.io/web-nfc/#the-nfcrecord-dictionary

#### Writing to an NFC tag

> The user opens a web page which can write an NFC tag.

> Note that an NFC write operation to an NFC tag always involves also a read
  operation.

```js
// Writing to an empty NFC tag.
// EXAMPLE 4: Read data from tag, and write to empty ones
navigator.nfc.watch((message) => {
  if (message.data[0].recordType == 'empty') {
    // Test assertion: check that an empty NFC tag is found.
    navigator.nfc.push({
      url: "/custom/path",
      data: [{ recordType: "text", data: 'Hello World' }]
    });
    // Test assertion: check that it is able to write to an empty NFC tag.
    // Test assertion: re-read the NFC tag and check that the message data is
    //                 the same one as pushed.
  } else {
    console.log('Read message written by ' + message.url);
    processMessage(message);
  }
}).then(() => {
  console.log("Added a watch.");
}).catch((error) => {
  console.log("Adding watch failed: " + error.name);
});
```

```js
// Writing to an NFC tag which already contains a Web NFC message with a
// different Web NFC message origin (i.e. overwriting a web-specific tag).
```

```js
// Writing to an NFC tag which already contains a Web NFC message with the same
// Web NFC message origin (i.e. updating own tag).
```

```js
// Writing to other, writable NFC tags (i.e. overwriting a generic tag).
// Pre-condition:
// Post-condition:

// EXAMPLE 1: Push a text string to either a tag or peer
navigator.nfc.push(
  '{ "prop1": "value1", "prop2": "value2" }'
).then(() => {
  console.log("Message pushed.");
  // Test assertion: check that navigator.nfc.push() returns a promise.
  // Test assertion: re-read the NFC tag and check that the message data is
  //                 the same text string as pushed.
}).catch((error) => {
  console.log("Push failed :-( try again.");
});

// EXAMPLE 3: Push a URL to either a tag or peer
navigator.nfc.push({
  data: [{ recordType: "url", data: "https://w3c.github.io/web-nfc/" }]
}).then(() => {
  console.log("Message pushed.");
  // Test assertion: re-read the NFC tag and check that the message data is
  //                 the same URL as pushed.
}).catch((error) => {
  console.log("Push failed :-( try again.");
});

// EXAMPLE 5: Save and restore game progress with another device
navigator.nfc.watch(reader, { url: "*/mypath/mygame/*" });

function reader(message) {
  console.log("Source:     " + message.url);
  console.log("Game state: " + message.data);

  var message = {
    url: "/mypath/mygame/update",
    data: [{
      recordType: "json",
      mediaType: "application/json",
      data: { level: 3, points: 4500, lives: 3 }
    }]
  };

  navigator.nfc.push(message).then(() => {
    // Test assertion: re-read the NFC tag and check that the message data is
    //                 the same JSON data as pushed.
    console.log('Progress stored!');
  }).catch((error) => {
    console.log('Failure, please try again.');
  });
}

// EXAMPLE 6: Push and read JSON (serialized and deserialized)
navigator.nfc.watch((message) => {
  for (let record of message.data) {
    // Test assertion: re-read the NFC tag and check that the message data is
    //                 the same JSON data as pushed.
    let article =/[aeio]/.test(record.data.title) ? "an" : "a";
    console.log(`$(record.data.name) is $(article) $(record.data.title)`);
  }
}, { url: document.baseURI, recordType: = "json" });

navigator.nfc.push({
  data: [
    {
      recordType: "json",
      mediaType: "application/json",
      data: {
        name: "Benny Jensen",
        title: "Banker"
      }
    },
    {
      recordType: "json",
      mediaType: "application/json",
      data: {
        name: "Zoey Braun",
        title: "Engineer"
      }
    }]
});

// EXAMPLE 7: Write data to tag and print out existing data
navigator.nfc.watch((message) => {
  for (let record of message.data) {
    console.log("Record type:  " + record.recordType);
    console.log("MIME type:    " + record.mediaType);
    console.log("=== data ===\n" + record.data);
  }
});

navigator.nfc.push(
  "Pushing data is fun!",
  {
    target: "tag",
    ignoreRead: false
  }
);
// Test assertion: not ready. Seems need to do a first read for better checking.

// EXAMPLE 8: Write Chinese text as UTF-8
let encoder = new TextEncoder([utfLabel = "utf-8"]);
let utf8Text = encoder.encode("ç”µè„‘åäº†ã€‚");

navigator.nfc.push({ data: [
  {
    recordType: "text",
    mediaType: "text/plain; lang=zh; charset=UTF-8;",
    data: utf8Text.buffer
  }
]});
// Test assertion: re-read the NFC tag and check that the message data is
//                 the same Chinese text as pushed.
// See https://encoding.spec.whatwg.org/#interface-textencoder
```

**Notes**:
* Inconsistent code indent in EXAMPLE 1, 2, 3

#### Pushing data to an NFC peer device

> On the initiating device the user would first have to navigate to a web site.
  The user would then touch the device against another Web NFC equipped device,
  and data transfer would occur.

> On the receiving device the UA will dispatch the content to an application
  registered and eligible to handle the content, and if that application is a
  browser which has a web page open and in focus that uses the Web NFC API and
  has set up a NFC watch to listen to Web NFC content, then the content is
  delivered to the web page through the parameters of an NFCMessageCallback.

```js
// EXAMPLE 2: Push a text string to a peer device
navigator.nfc.push(
  "Text meant for peers only", { target: "peer" }
).then(() => {
  console.log("Message pushed.");
  // Test assertion: re-read the NFC peer and check that the message data is
  //                 the same text string as pushed.
}).catch((error) => {
  console.log("Push failed :-( try again.");
});

// EXAMPLE 3: Push a URL to either a tag or peer
navigator.nfc.push({
  data: [{ recordType: "url", data: "https://w3c.github.io/web-nfc/" }]
}).then(() => {
  console.log("Message pushed.");
  // Test assertion: re-read the NFC peer and check that the message data is
  //                 the same URL as pushed.
}).catch((error) => {
  console.log("Push failed :-( try again.");
});
```

### Method Parameter to Test

This section will focus on various kind of **valid** input values (parameters)
to the methods in the NFC interface.

```js
// WebIDL of the NFC interface
// https://w3c.github.io/web-nfc/#the-nfc-interface
typedef (DOMString or ArrayBuffer or NFCMessage) NFCPushMessage;

interface NFC {
    Promise<void> push(NFCPushMessage message, optional NFCPushOptions options);
    Promise<void> cancelPush(optional NFCPushTarget target = "any");
    Promise<long> watch(MessageCallback callback, optional NFCWatchOptions options);
    Promise<void> cancelWatch(optional long id);
};

callback MessageCallback = void (NFCMessage message);
```

Generally the test cases will read an NFC device, re-write message to the device
and then re-read the device to check the data comparing to that pushed.
Therefore test assertions designed below will focus on individual parameter to
a certain method, without optional paramenter if not test that parameter, and
with rest mandatory parameter(s) as default or simple value(s).

#### DOMString as NFCPushMessage

According to https://heycam.github.io/webidl/#es-DOMString, an ECMAScript value
is able to be converted to an IDL DOMString value. And there are [lots of such
kind of
values](https://github.com/w3c/web-platform-tests/pull/271/files#diff-ebea7eac2263f684d9017d3aa966505eR20).
Actually I don't want to check it as such comprehensive. It is enough to check
only some string values like empty string, string and unicode.

```js
navigator.nfc.push('');
// Test assertion: check that it is able to push empty text to an NFC device.
// There are maybe some problem in this test e.g. how to check the read data?

navigator.nfc.push('hello');
// This checkpint has been covered by EXAMPLE 2

navigator.nfc.push('a\uD800\uDC00a');
// Test assertion: check that it is able to push unicode string to an NFC
// device.
```

#### ArrayBuffer as NFCPushMessage

https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer
says we cannot directly manipulate the contents of an `ArrayBuffer`; instead, we
can create one of the typed array objects or a DataView object which represents
the buffer in a specific format, and use that to read and write the contents of
the buffer. So we will use typed array to make array buffer.

EXAMPLE 8 uses `TextEncoder` which is specified by the
[Encoding](http://encoding.spec.whatwg.org/#interface-textdecoder) spec,
in which the `TextEncoder.encode` method returns a **Uint8Array** containing
the text given in parameters encoded with the specific method for that
TextEncoder object. We will also use this method to make array buffer.

The [FileAPI](https://w3c.github.io/FileAPI/#readAsArrayBuffer) has
`readAsArrayBuffer` method that can help get an array buffer from a local file.
However this is not helpful for automating the tests. We won't use it.

```js
var arrayBuffer; // Can be one of the following array buffers.
navigator.nfc.push(arrayBuffer);
// Test assertions: check that it is able to push array buffer to an NFC device.

arrayBuffer = new ArrayBuffer(8);
```

#### NFCMessage as NFCPushMessage



### Algorithm, Statement to Test

Please note that
* "passing too few arguments must throw TypeError"
  has been tested by idlharness.js `IdlInterface.prototype.test_interface_of`
  at https://github.com/w3c/testharness.js/blob/master/idlharness.js#L1461
* "passing arguments of the wrong type" may be supported by idlharness.js
  `IdlInterface.prototype.test_interface_of` at the same place sometime in the
  future; thus these tests designed here are subjected to be replaced.
* **TypeError** indicates the actual type of an operand is different than the
  expected type. **SyntaxError** indicates that a parsing error has occurred.
  [ECMAScript 2015](http://www.ecma-international.org/ecma-262/6.0/#sec-native-error-types-used-in-this-standard-typeerror)
* [DOM 4](http://www.w3.org/TR/dom/#syntaxerror)
  says **SyntaxError** means the string did not match the expected pattern.
* However, there are still some interesting discussions about the TypeError and
  SyntaxError exceptions. Simon told me that [WebIDL conversion happens first;
  the input to the postMessage algorithm is IDL
  values](https://critic.hoppipolla.co.uk/showcomments?review=3331&filter=all).
  And I agreed to it. See more at
  https://github.com/w3c/web-platform-tests/pull/1435,
  https://github.com/w3c/web-platform-tests/pull/974,
  https://github.com/w3c/webrtc-pc/issues/35.


## References

* Dominique Hazael-Massieux, Marcos Caceres. A Method for Writing Testable
  Conformance Requirements. W3C Working Group Note 28 January 2010. URL:
  http://www.w3.org/TR/test-methodology/
* Kenneth Rohde Christiansen, Zoltan Kis. Web NFC API. Draft Community Group
  Report 13 November 2015. URL: https://w3c.github.io/web-nfc/
* Testing Web Bluetooth. Draft Community Group Report, 23 September 2015. URL:
  https://webbluetoothcg.github.io/web-bluetooth/tests/
